<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <link href="http://gmpg.org/xfn/11" rel="profile">

  <title>
    Building for the Atmel "SAMD20 Xplained Pro" in Ubuntu 14.04 &middot; 
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:300,400italic,400,600,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.png">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  
</head>


  <body>

    <header class="masthead">
      <div class="masthead-inner">
        <h1></h1>
        <p class="lead">Engineering Field Notes. Made by <a href="http://electronics.stackexchange.com/users/31199/jjmilburn" target="_blank">@jjmilburn</a>.</p>

        <div class="colophon">
          <ul class="colophon-links">
            <li>
              <a href="">Nothing.</a>
            </li>
            <li>
              <a href="https://github.com/jjmilburn">Me Github</a>
            </li>
            <li>Currently v0.9.0</li>
          </ul>
          <p>&copy; 2014. Josh Milburn All rights reserved.</p>
        </div>
      </div>
    </header>

    <div class="content container">
      <div class="post">
  <h1>Building for the Atmel "SAMD20 Xplained Pro" in Ubuntu 14.04</h1>
  <span class="post-date">18 Sep 2014</span>
  <p>This is a brief outline of the steps taken to get sample code from the Atmel ASF for the “SAMD20 Xplained Pro” built and flashed to the board from Ubuntu 14.04.  Much of this guide is built around insights from <a href="https://plus.google.com/+AndreyYurovsky/posts/5JTehC7ngTq">AndreyYurovsky</a> and <a href="http://blog.matwey.name/2013/12/atmel-atsamd20-xpro.html">V. Kornilov Matwey</a>.</p>

<hr />

<h3 id="prerequisite-hardware">Prerequisite Hardware</h3>

<ul>
  <li><a href="http://www.atmel.com/Images/Atmel-42147-SAM-D20-Getting-Started-with-SAMD20_Application-Note_AT03293.pdf">“Atmel SAM D20 Xplained Pro Evaluation Kit (ATSAMD20-XPRO)”</a></li>
  <li><a href="http://www.atmel.com/Images/Atmel-42129-SAM-D20_Datasheet.pdf">SAMD20 Datasheet</a></li>
</ul>

<h3 id="software-installation">Software Installation</h3>

<ul>
  <li>
    <p><a href="http://www.eclipse.org/cdt/">Eclipse CDT</a> this is an Eclipse IDE tailored to C/C++ development.  This guide was written for Eclipse Kepler, install this first.</p>
  </li>
  <li>
    <p><a href="https://launchpad.net/gcc-arm-embedded">GNU Tools for Embedded Processors</a> this is a toolchain that has worked on Cortex M0/M0+ processors.  This guide is tested using version 2014-q2.</p>
  </li>
  <li>
    <p>Atmel makes the <a href="http://www.atmel.com/tools/AVRSOFTWAREFRAMEWORK.aspx">“Atmel Software Framework”</a>, available which provides plenty of actual code to begin working on the SAMD20 board.  Download this file; its large (200MB).  This guide was written for version 3.19.0 (“xdk-asf-3.19.0”).</p>
  </li>
  <li>
    <p><a href="http://sourceforge.net/p/openocd/tickets/milestone/0.9.0/">OpenOCD 0.9.0</a> is used to actually connect to the board.  To install this, follow the instructions at https://plus.google.com/+AndreyYurovsky/posts/5JTehC7ngTq, transcribed here for convenience:</p>
  </li>
</ul>

<p>Execute the following:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sudo apt-get install libudev-dev
git clone git://github.com/signal11/hidapi.git
cd hidapi
./bootstrap
./configure
make
sudo make install
</code></pre>
</div>

<p>Now, make sure that your sources.list file contains ‘deb-src’ entries.  If it doesn’t, copy the existing ‘deb’ entries for Ubuntu repositories, and create an identical line for each of them, with ‘deb’ replaced by ‘deb-src’.  For example, here is my sources.list file:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>deb http://mirror.math.ucdavis.edu/ubuntu/ trusty main universe restricted multiverse
deb-src http://mirror.math.ucdavis.edu/ubuntu/ trusty main universe restricted multiverse
deb http://mirror.math.ucdavis.edu/ubuntu/ trusty-updates main universe restricted multiverse
deb-src http://mirror.math.ucdavis.edu/ubuntu/ trusty-updates main universe restricted multiverse
deb http://security.ubuntu.com/ubuntu/ trusty-security main universe restricted multiverse
deb-src http://security.ubuntu.com/ubuntu/ trusty-security main universe restricted multiverse
</code></pre>
</div>

<p>Now, obtain the OpenOCD source code, and build it:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>git clone git://git.code.sf.net/p/openocd/code openocd
cd openocd
sudo apt-get build-dep openocd
./bootstrap
./configure
</code></pre>
</div>

<p>The output at this point (after ./configure) should look like the following image.  Specifically, note that CMSIS-DAP support is present:
<img src="/assets/images/OpenOCD_Config_CMSIS.png" alt="OpenOCD_CMSIS-DAP" /></p>

<p>Then run:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>make
sudo make install
</code></pre>
</div>

<p>At this point, you can try to launch OpenOCD to ensure that the install completed succesfully.  If an error along the lines of “error while loading shared libraries: libhidapi-hidraw.so.0” occurs, just run the following and retry:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sudo apt-get install libhidapi-hidraw0
</code></pre>
</div>

<p>Now, copy the udev rules for OpenOCD to the appropriate location, so that the SAMD20 Xplained Pro board is properly identified when plugged into USB:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sudo cp contrib/99-openocd.rules /etc/udev/rules.d/99-openocd.rules
sudo udevadm control --reload-rules
</code></pre>
</div>

<p>Now, if you plug in “SAMD20 Xplained Pro” via USB, and run the following command:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>openocd -f /./usr/local/share/openocd/scripts/board/atmel_samd20_xplained_pro.cfg 
</code></pre>
</div>

<p>The following (or similar) output should result:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Open On-Chip Debugger 0.9.0-dev-00148-g3a4ec66 (2014-09-18-14:32)
Licensed under GNU GPL v2
For bug reports, read
    http://openocd.sourceforge.net/doc/doxygen/bugs.html
Info : only one transport option; autoselect 'cmsis-dap'
adapter speed: 500 kHz
adapter_nsrst_delay: 100
cortex_m reset_config sysresetreq
Info : CMSIS-DAP: SWD  Supported
Info : CMSIS-DAP: Interface Initialised (SWD)
Info : CMSIS-DAP: FW Version = 01.1A.00FB
Info : SWCLK/TCK = 1 SWDIO/TMS = 1 TDI = 1 TDO = 1 nTRST = 0 nRESET = 1
Info : DAP_SWJ Sequence (reset: 50+ '1' followed by 0)
Info : CMSIS-DAP: Interface ready
Info : clock speed 500 kHz
Info : IDCODE 0x0bc11477
Info : at91samd20j18.cpu: hardware has 4 breakpoints, 2 watchpoints    
</code></pre>
</div>

<p>This indicates that OpenOCD is successfully connected to the board; more specifically, to the debugger chip located on the backside of the board (note the microcontroller closer to the USB port).  The “Interface Initialised (SWD)” indicates that the debugger is connected to the MCU.</p>

<ul>
  <li>Note: it may be possible to use this onboard debugger to connect to other SAMD20 MCUs external to the development board by connecting to the external header pins for SWD.</li>
</ul>

<p>At this point, if you receive an error indicating “unable to open CMSIS-DAP device”, try a different USB port (or try unplugging other USB devices).Also, confirm that ‘Atmel Corp.’ appears in lsusb when the board is plugged in.</p>

<h3 id="importing-asf-example-into-eclipse">Importing ASF Example into Eclipse</h3>

<ul>
  <li>Launch Eclipse CDT, and navigate to “File-&gt;Import”.  Select “Existing Projects into Workspace” from “General”.</li>
  <li>From here, navigate to the directory where you downloaded/unzipped the ASF; for me, its called “xdk-asf-3.19.0”</li>
  <li>
    <p>Navigate to the LED Toggle example project for SAMD20 Xplained, which is found at:
  xdf-asf-3.19.0/sam0/applications/led_toggle/samd20_xplained_pro/gcc
<img src="/assets/images/Import_SAMD20_Example.png" alt="Import SAMD20 Example" /></p>
  </li>
  <li>Click “Copy Projects into Workspace”, and click Finish.</li>
</ul>

<p>At this point, the project should be in your workspace, and a directory structure something like the following image, without the binaries is likely what shows up in the project tree:</p>

<p><img src="/assets/images/SAMD20_Project_Tree.png" alt="Project Tree" /></p>

<p>Note that “config.mk” and “Makefile” are both here, these are important.</p>

<p>If you try to build this, you will likely encounter errors – the pathing for the Makefile doesn’t expect the example to be located in your workspace, so a few files have to change to accommodate this.</p>

<p>Open the Makefile (which is now in your workspace, in the imported project), and notice the following line:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>MAKEFILE_PATH = ../../../../../sam0/utils/make/Makefile.sam.in
</code></pre>
</div>

<p>We will need to change this to point to where the “xdk-asf-3.19.0” directory is located.  An easy solution (probably not best practices for project structure, but it will work) is to copy the xdk-asf-3.19.0 directory into the project directory, and make the following change in the Makefile:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>#in the makefile, comment this out
###MAKEFILE_PATH = ../../../../../sam0/utils/make/Makefile.sam.in
#replace with the following line
MAKEFILE_PATH = xdk-asf-3.19.0/sam0/utils/make/Makefile.sam.in
</code></pre>
</div>

<p>Next, open “config.mk” in the project directory, and find the following section:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Path to top level ASF directory relative to this project directory.
PRJ_PATH = ../../../../..
</code></pre>
</div>

<p>Change this section to the correct path, as here:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>#Path to top level ASF directory relative to this project directory.
#Note that since we moved the ASF directory into the project directory, 
#just type in the name of the ASF directory.
PRJ_PATH = xdk-asf-3.19.0/
</code></pre>
</div>

<p>Next, right click on the project, and go to properties.  From the C/C++ Build section, under “Builder Settings”,
uncheck “Use Default Build Command”, and type “make -f Makefile” instead, as in the following image:</p>

<p><img src="/assets/images/CDT_Builder_Makefile.png" alt="CDT Builder Makefile Dialog" /></p>

<p>Now, apply the change, refresh the project, and attempt to build.  With any luck, you’ll end up with a successful build, producing .elf and .hex files that can then be used to program the board.</p>

<h3 id="installing-program-to-samd20-xplained-pro">Installing Program to SAMD20 Xplained Pro</h3>

<p>We’ll use gdb for this step, so run the following:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sudo apt-get install gdb
</code></pre>
</div>

<p>Open a terminal, get OpenOCD up and running as in the previous step, and connect to the board.  Ensure that the below line appears:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>info : at91samd20j18.cpu: hardware has 4 breakpoints, 2 watchpoints 
</code></pre>
</div>

<p>Next, open another terminal, and navigate to the Eclipse workspace where your project resides.  Navigate to where the generated files are (look for the .bin and .elf files) and type the following in the terminal (from Andrey Yurovsky’s G+ post):</p>

<div class="highlighter-rouge"><pre class="highlight"><code>arm-none-eabi-gdb -ex "target remote localhost:3333" -ex "mon reset halt" low_power_flash.elf
</code></pre>
</div>

<p>This will cause some additional lines of output to appear in your OpenOCD window; this is expected.  See the below:</p>

<p><img src="/assets/images/OpenOCD_AfterGDB.png" alt="OpenOCD After GDB" /></p>

<p>Next, in gdb, type the following:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>load
mon reset init
c
</code></pre>
</div>

<p>Now, pressing the SW0 button (not the reset button) on the SAMD20 Xplained Pro dev board will light LED0.</p>

<h3 id="next-steps">Next Steps</h3>

<p>To experiment, look at the “config.mk” file, and see where the source files are being pulled from – to build your own files, just modify these entires in config.mk, and have at it.</p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="Other Posts">
    
      <li>
        <h3>
          <a href="/2017/03/18/Cellular-Certification-in-USA/">
            The Basics - Certifying a Cellular Product in the US
            <small>18 Mar 2017</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2017/01/02/embedded-gcc-beyond-wall/">
            Embedded Gcc Beyond Wall
            <small>02 Jan 2017</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2016/04/04/ttyUSB-to-vagrant-virtualbox/">
            Sharing a Prolific USB->UART Converter with VirtualBox
            <small>04 Apr 2016</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-88387479-1', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>
